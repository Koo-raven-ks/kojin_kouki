{% extends "kojin_kouki_kadai/base.html" %}
{% load static %}

{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block content %}
<h1>ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

<!-- ã‚°ãƒ©ãƒ•è¡¨ç¤º -->
<div class="row mb-5">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥èª²é¡Œæ•°</h6>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6>å„ªå…ˆåº¦åˆ¥èª²é¡Œæ•°</h6>
            </div>
            <div class="card-body">
                <canvas id="priorityChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6>æœŸé™åˆ¥æœªæå‡ºèª²é¡Œ</h6>
            </div>
            <div class="card-body">
                <canvas id="deadlineChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6>è¬›ç¾©åˆ¥èª²é¡Œæ•°ï¼ˆä¸Šä½5ä»¶ï¼‰</h6>
            </div>
            <div class="card-body">
                <canvas id="lectureChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
<div class="row mb-5">
    <div class="col-md-3 mb-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h5>å…¨èª²é¡Œ</h5>
                <p class="display-6 text-primary">{{ all_assignments.count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <h5>æœªæå‡º</h5>
                <p class="display-6 text-warning">{{ pending_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <h5>æå‡ºæ¸ˆã¿</h5>
                <p class="display-6 text-info">{{ submitted_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h5>æ¡ç‚¹æ¸ˆã¿</h5>
                <p class="display-6 text-success">{{ graded_count }}</p>
            </div>
        </div>
    </div>
</div>

<!-- é«˜å„ªå…ˆåº¦èª²é¡Œ -->
{% if urgent_assignments %}
<div class="card mb-4">
    <div class="card-header" style="background-color: #e74c3c; color: white;">
        <h5>âš ï¸ é«˜å„ªå…ˆåº¦ãƒ»æœªæå‡ºï¼ˆ{{ urgent_count }}ä»¶ï¼‰</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>èª²é¡Œå</th>
                        <th>è¬›ç¾©</th>
                        <th>æœŸé™</th>
                        <th>æ®‹ã‚Š</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in urgent_assignments %}
                    <tr>
                        <td><strong>{{ assignment.title }}</strong></td>
                        <td>{{ assignment.lecture.name }}</td>
                        <td>{{ assignment.due_date|date:"m/d H:i" }}</td>
                        <td>
                            {% if assignment.days_until_due < 0 %} <span class="badge bg-danger">æœŸé™è¶…é</span>
                                {% elif assignment.days_until_due == 0 %}
                                <span class="badge bg-danger">æœ¬æ—¥</span>
                                {% else %}
                                {{ assignment.days_until_due }}æ—¥
                                {% endif %}
                        </td>
                        <td><a href="{% url 'assignment_detail' assignment.pk %}" class="btn btn-sm btn-primary">è©³ç´°</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- å…¨èª²é¡Œä¸€è¦§ -->
<div class="card">
    <div class="card-header">
        <h5>ğŸ“‹ å…¨èª²é¡Œä¸€è¦§</h5>
    </div>
    <div class="card-body">
        {% if all_assignments %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>èª²é¡Œå</th>
                        <th>è¬›ç¾©</th>
                        <th>å„ªå…ˆåº¦</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th>æœŸé™</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in all_assignments %}
                    <tr>
                        <td>{{ assignment.title }}</td>
                        <td>{{ assignment.lecture.name }}</td>
                        <td>
                            {% if assignment.priority == 'high' %}
                            <span class="badge bg-danger">é«˜</span>
                            {% elif assignment.priority == 'medium' %}
                            <span class="badge bg-warning">ä¸­</span>
                            {% else %}
                            <span class="badge bg-secondary">ä½</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if assignment.status == 'pending' %}
                            <span class="badge bg-secondary">æœªæå‡º</span>
                            {% elif assignment.status == 'submitted' %}
                            <span class="badge bg-info">æå‡ºæ¸ˆã¿</span>
                            {% else %}
                            <span class="badge bg-success">æ¡ç‚¹æ¸ˆã¿</span>
                            {% endif %}
                        </td>
                        <td>{{ assignment.due_date|date:"m/d" }}</td>
                        <td><a href="{% url 'assignment_detail' assignment.pk %}" class="btn btn-sm btn-primary">è©³ç´°</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">èª²é¡ŒãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>
</div>

<div class="mt-4">
    <a href="{% url 'lecture_create' %}" class="btn btn-primary">+ è¬›ç¾©ã‚’è¿½åŠ </a>
    <a href="{% url 'assignment_create' %}" class="btn btn-primary">+ èª²é¡Œã‚’è¿½åŠ </a>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // ãƒ¢ãƒã‚¯ãƒ­ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
    const grayColors = {
        dark: '#2c3e50',
        medium: '#34495e',
        light: '#7f8c8d',
        lighter: '#95a5a6',
        lightest: '#bdc3c7'
    };

    // 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥èª²é¡Œæ•°ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['æœªæå‡º', 'æå‡ºæ¸ˆã¿', 'æ¡ç‚¹æ¸ˆã¿'],
            datasets: [{
                data: [{{ pending_count }}, {{ submitted_count }}, {{ graded_count }}],
        backgroundColor: [grayColors.lighter, grayColors.medium, grayColors.dark],
        borderWidth: 2,
        borderColor: '#fff'
        }]
    },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

    // 2. å„ªå…ˆåº¦åˆ¥èª²é¡Œæ•°ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    new Chart(priorityCtx, {
        type: 'bar',
        data: {
            labels: ['é«˜', 'ä¸­', 'ä½'],
            datasets: [{
                label: 'èª²é¡Œæ•°',
                data: [{{ high_priority }}, {{ medium_priority }}, {{ low_priority }}],
        backgroundColor: [grayColors.dark, grayColors.medium, grayColors.light],
        borderWidth: 1,
        borderColor: grayColors.dark
        }]
    },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

    // 3. æœŸé™åˆ¥æœªæå‡ºèª²é¡Œï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
    const deadlineCtx = document.getElementById('deadlineChart').getContext('2d');
    new Chart(deadlineCtx, {
        type: 'bar',
        data: {
            labels: ['æœŸé™è¶…é', 'ä»Šé€±', 'æ¥é€±', '2é€±é–“ä»¥é™'],
            datasets: [{
                label: 'æœªæå‡ºèª²é¡Œæ•°',
                data: [{{ overdue }}, {{ this_week }}, {{ next_week }}, {{ later }}],
        backgroundColor: [grayColors.dark, grayColors.medium, grayColors.light, grayColors.lighter],
        borderWidth: 1,
        borderColor: grayColors.dark
        }]
    },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

    // 4. è¬›ç¾©åˆ¥èª²é¡Œæ•°ï¼ˆæ¨ªæ£’ã‚°ãƒ©ãƒ•ï¼‰
    const lectureCtx = document.getElementById('lectureChart').getContext('2d');
    const lectureLabels = [{% for lecture in lectures_data %}'{{ lecture.name|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const lectureData = [{% for lecture in lectures_data %}{{ lecture.assignment_count }}{% if not forloop.last %}, {% endif %}{% endfor %}];

    new Chart(lectureCtx, {
        type: 'bar',
        data: {
            labels: lectureLabels,
            datasets: [{
                label: 'èª²é¡Œæ•°',
                data: lectureData,
                backgroundColor: grayColors.medium,
                borderWidth: 1,
                borderColor: grayColors.dark
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
</script>
{% endblock %}